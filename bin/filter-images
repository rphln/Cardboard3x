#!/usr/bin/env -S poetry run python3

from json import loads
from pathlib import Path
from random import shuffle

import click
from tqdm import tqdm

SETS = {
    "training": 2 ** 15,
    "validation": 2 ** 11,
    "tests": 2 ** 11,
    "experiments-training": 2 ** 11,
    "experiments-validation": 2 ** 7,
}


@click.command()
@click.option("--metadata", required=True, type=Path)
@click.option("--source", required=True, type=Path)
@click.option("--target", required=True, type=Path)
def cli(metadata: Path, source: Path, target: Path):
    target.mkdir(exist_ok=True, parents=True)

    metadata = metadata.glob("*")
    source = source.glob("**/*.png")

    available = set()

    for file in tqdm(metadata, desc="Loading metadata"):
        with open(file) as lines:
            for line in lines:
                current = loads(line)

                if current["rating"] == "s":
                    available.add(current["id"])

    candidates = [file for file in source if file.stem in available]
    shuffle(candidates)

    skip = 0
    for name, size in SETS.items():
        subset = target / name
        subset.mkdir(exist_ok=True)

        for candidate in tqdm(candidates[skip : skip + size], desc=f"Linking `{name}`"):
            source_: Path = candidate.resolve()
            target_: Path = subset / source_.name

            target_.symlink_to(source_)

        skip += size


if __name__ == "__main__":
    cli()
